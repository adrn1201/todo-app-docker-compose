name: Publish Docker Image
on:
    push:
        branches:
        - master
jobs:
    publish:
        runs-on: ubuntu-latest
        environment: dev
        env:
            GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
        steps:
            - name: Get Code
              uses: actions/checkout@v4
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2
            - name: Login to Docker
              run: echo "${{ secrets.GH_ACCESS_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            - name: Check and create VERSION file if not exists
              run: |
                if [ ! -f VERSION ]; then
                  echo "1.0.0" > VERSION
                  git config --global user.name "${{ github.actor }}"
                  git config --global user.email "${{ github.actor }}@users.noreply.github.com"
                  git add VERSION
                  git commit -m "Create VERSION file with initial version 1.0.0"
                  git push origin master
                fi
            - name: Extract version
              id: vars
              run: |
                VERSION=$(cat VERSION)
                echo "VERSION=$VERSION" >> $GITHUB_ENV
            - name: Build Docker Image
              run: docker build -t ghcr.io/adrn1201/todo-app:${{ env.VERSION }} .
            - name: Push Docker Image
              run: docker push ghcr.io/adrn1201/todo-app:${{ env.VERSION }}
            - name: Increment version
              run: |
                VERSION=$(cat VERSION)
                NEW_VERSION=$(echo $VERSION | awk -F. -v OFS=. '{$NF++;print}')
                echo $NEW_VERSION > VERSION
                git config --global user.name "${{ github.actor }}"
                git config --global user.email "${{ github.actor }}@users.noreply.github.com"
                git add VERSION
                git commit -m "Increment version to $NEW_VERSION"
                git push origin master
    report:
        needs: publish
        if: success()
        runs-on: ubuntu-latest
        steps:
          - name: Display Deployment Summary
            run: |
              echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
              echo "- 🌍 **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
              echo "- 👤 **Pushed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
              echo "- 🐳 **Docker Image**: ghcr.io/adrn1201/todo-app:${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Environment**: dev ⚙️" >> $GITHUB_STEP_SUMMARY
              echo "- **Status**: ✅ Successful" >> $GITHUB_STEP_SUMMARY